#include "iWatch.h"

static unsigned char CODE Icon[] = {
	48, 48,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x60,0x30,0x10,0x18,0x08,0x0C,0x04,
	0x06,0x06,0x02,0x02,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x02,0x02,0x06,0x06,
	0x04,0x0C,0x08,0x18,0x10,0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0xC0,0x70,0x1C,0x06,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,
	0xE0,0xE0,0x70,0x70,0x78,0x38,0x78,0x70,0xF0,0xE0,0xE0,0xEC,0xFE,0x3F,0x3F,0x3F,
	0x3E,0x1C,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x06,0x1C,0x70,0xE0,0x00,0x00,
	0xF0,0xFF,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xB0,0xB0,0xB0,0xB0,0xB0,
	0xB0,0x10,0x00,0xE0,0xF0,0xF8,0xFC,0xFE,0xFF,0x7F,0x3F,0x1F,0x1F,0x3F,0x7E,0x78,
	0x70,0x70,0x38,0x38,0x38,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xFF,0xF0,
	0x0F,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0D,0x0D,0x0D,0x0D,0x0D,
	0x0D,0x0D,0x8C,0xC9,0xC3,0xC7,0xC7,0xEF,0xFF,0xFF,0xFC,0xF8,0x70,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xFF,0x0F,
	0x00,0x00,0x03,0x0E,0x38,0x60,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x01,0x01,0x01,0xE1,0xF9,0x7C,0x3E,0x0E,0x06,0x03,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xC0,0x60,0x38,0x0E,0x07,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x03,0x06,0x0C,0x08,0x18,0x10,0x30,0x20,
	0x60,0x60,0x40,0x40,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0x40,0x40,0x60,0x60,
	0x20,0x30,0x30,0x18,0x08,0x0C,0x06,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	/* (48 X 48 )*/
};
static t_psWidget text1, text2, text3;
static t_psWidget canvas1;
static t_psGroup group1;
//static unsigned int code ch1[] = "今日步数";
static unsigned int code ch1[] = {0xbdf1, 0xc8d5, 0xb2bd, 0xcafd, 0xA3BA, '\0'};  //测试发现，keil5不能把一些中文字符转正确的转译成GB2312编码
static unsigned int code ch2[] = {0xc0fa, 0xcab7, 0xb2bd, 0xcafd, 0xA3BA, '\0'};	//所以这里直接输入查表后的GB2312编码，分别是字符串“今日步数”，“历史步数”
static float a = 0;
static unsigned char page = 0;

/**
  * @brief  页面初始化事件
  * @param  无
  * @retval 无
  */
static void Setup(unsigned char condition)
{
	text1 = og_label_create(FONT_GB2312_15X16, 0, 0);
	og_label_setText(text1, (char *)ch1);
	text2 = og_label_create(FONT_ASCII_8X16, 120, 0);
	text3 = og_label_create(FONT_GB2312_15X16, 0, 16);
	og_label_setText(text3, (char *)ch2);
	canvas1 = og_canvas_create(128, 56, 0, 36);
	group1 = og_group_create(4);
	og_group_addWidget(group1, text1, 0);
	og_group_addWidget(group1, text2, 0);
	og_group_addWidget(group1, text3, 0);
	og_group_addWidget(group1, canvas1, 0);
	og_group_setPosOffset(group1, 0, 64);
	og_group_addAnimOffset(group1, 0, -64, ANIM_TIME_NORM, ANIM_NULL_CB);
	a = 0;
	page = 0;
}
static void delet(void)
{
	og_group_delet(group1);
	pageSetStatus(page_pedometer, PAGE_IDLE);
}
/**
  * @brief  页面退出事件
  * @param  无
  * @retval 无
  */
static void Exit(unsigned char condition)
{
	og_group_hideOffScreenWidget(group1);
	og_group_addAnimOffset(group1, 0, 64, ANIM_TIME_NORM, delet);
}
/**
  * @brief  页面循环执行的内容
  * @param  无
  * @retval 无
  */
static void Loop()
{
	if(pageExecuteRate(&Rate20Hz))
	{
		lablel_printf(text2, "%u", LSM6DSMGetCurrentStep());
		og_widget_setPos(text2, 128 - text2->w, text2->y);
	}
	if(pageExecuteRate(&Rate50Hz))
	{
		if(a < 1)
		{		
			unsigned char i = 0, y = 0;
			unsigned int max_step = 0;
			float scale, w;
			unsigned char str[6];
			og_canvas_clear(canvas1);
			for(i = 0; i < 7; i++)
			{
				if(config.step_data[i].month == 0)
					continue;
				sprintf(str, "% 2u/%u", config.step_data[i].month, config.step_data[i].day);
				og_canvas_drawText(canvas1, str, 0, y);
				if(config.step_data[i].step > max_step)
					max_step = config.step_data[i].step;
				y += 8;
			}
			scale = 67.0 / max_step;
			for(i = 0, y = 0; i < 7; i++)
			{
				if(config.step_data[i].month == 0)
					continue;
				w = config.step_data[i].step * scale * a;
				og_canvas_drawRectangle(canvas1, w, 8, 30, y);
				sprintf(str, "%u", config.step_data[i].step);
				og_canvas_drawText(canvas1, str, w + 32, y);
				y += 8;
			}
			a += 0.02;
		}			
	}
}
/**
  * @brief  页面事件
  * @param  btn:发出事件的按键
  * @param  event:事件编号
  * @retval 无
  */
static void Event(unsigned char event)
{
	if(event == KEY1_PRESSED || event == AWT)
		pageShift(page_menu, PAGE_RETURN);
	else if(event == KEY4_PRESSED)
	{
		if(page == 0)
		{
			page = 1;
			og_group_addAnimOffset(group1, 0, -28, ANIM_TIME_NORM, ANIM_NULL_CB);
		}
	}
	else if(event == KEY2_PRESSED)
	{
		if(page == 1)
		{
			page = 0;
			og_group_addAnimOffset(group1, 0, 28, ANIM_TIME_NORM, ANIM_NULL_CB);
		}
	}
}
void pageRegister_page_pedometer(unsigned char pageID)
{
	pageRegister(pageID, "PEDOMETER", Icon, Setup, Loop, Exit, Event);
}