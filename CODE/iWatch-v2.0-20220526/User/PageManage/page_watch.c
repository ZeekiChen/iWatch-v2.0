#include "iWatch.h"
#include "stdio.h"

static t_psWidget digit[8];
static t_psWidget text1;
static t_psWidget	bmp1, bmp2, bmp3;
static t_psGroup group1;
static unsigned char xdata str[18];
static unsigned char xdata str_last[6];
static unsigned char xdata change_step = 24, change_num = 0, change_index = 0;
static unsigned char xdata digit_temp[6][98] = {{16,48}, {16,48}, {16,48}, {16,48}, {16,48}, {16,48}};
unsigned char code WEEKDAY_IN_STR[7][6];
unsigned char code DIGIT[10][96];
unsigned char code COLON[98];
	
unsigned char code CLOCK_BELL_ICON[10] = {
	8, 8,
	0x20,0x30,0x6E,0xA1,0xA1,0x6E,0x30,0x20
};
unsigned char code TIMER_ICON[10] = {
	8, 8,
	0x3C,0x42,0x81,0x9D,0x91,0x91,0x42,0x3C
};

void DisplayTimeInAnim(void);
	
/**
  * @brief  页面初始化事件
  * @param  无
  * @retval 无
  */
static void Setup(unsigned char condition)
{
	unsigned char i, j;
	RX8130CEReadTime(&time);
	sprintf(str, "%02d%02d%02d", (int)time.hour, (int)time.minute, (int)time.second);
	for(i = 0; i < 6; i++)
	{
		for(j = 0; j < 96; j++)
			digit_temp[i][j+2] = DIGIT[str[i]-'0'][j];
	}
	for(i = 0; i < 6; i++)
		str_last[i] = str[i];
	//时间显示
	for(i = 0; i < 6; i++)
		digit[i] = og_bmp_create((t_psBMP)digit_temp[i], (i * 16 + (i /2) * 16), 8);
	digit[6] = og_bmp_create((t_psBMP)COLON, 32, 8);
	digit[7] = og_bmp_create((t_psBMP)COLON, 80, 8);
	//日期显示
	text1 = og_label_create(FONT_ASCII_5X7, 0, 56);
	//电池、闹钟计时器图标
	bmp1 = og_bmp_create((t_psBMP)battery, 104, 0);
	bmp2 = og_bmp_create((t_psBMP)CLOCK_BELL_ICON, 0, 0);
	og_widget_setShow(bmp2, config.alarm.mode);
	bmp3 = og_bmp_create((t_psBMP)TIMER_ICON, 0, 0);
	og_widget_setShow(bmp3, iWatchCheckStatus(IWATCH_TIMERON));
	group1 = og_group_create(12);
	for(i = 0; i < 8; i++)
		og_group_addWidget(group1, digit[i], 0);
	og_group_addWidget(group1, text1, 0);
	og_group_addWidget(group1, bmp1, 0);
	og_group_addWidget(group1, bmp2, 0);
	og_group_addWidget(group1, bmp3, 0);
	og_group_setPosOffset(group1, 0, -64);
	og_group_addAnimOffset(group1, 0, 64, ANIM_TIME_NORM, ANIM_NULL_CB);
}
static void delet(void)
{
	og_group_delet(group1);
	pageSetStatus(page_watch, PAGE_IDLE);
}
/**
  * @brief  页面退出事件
  * @param  无
  * @retval 无
  */
static void Exit(unsigned char condition)
{
	og_group_addAnimOffset(group1, 0, -64, ANIM_TIME_NORM, delet);
}
/**
  * @brief  页面循环执行的内容
  * @param  无
  * @retval 无
  */
static void Loop()
{
	if(pageExecuteRate(&Rate10Hz))
	{
		char i;
		//显示小图标
		og_widget_setShow(bmp2, config.alarm.mode);
		og_widget_setPos(bmp3, config.alarm.mode?9:0, 0);
		og_widget_setShow(bmp3, iWatchCheckStatus(IWATCH_TIMERON));
		RX8130CEReadTime(&time);
		sprintf(str, "%02d%02d%02d", (int)time.hour, (int)time.minute, (int)time.second);
		if(change_step == 24)
		{
			for(i = 5; i >= 0; i--)
			{
				if(str[i] != str_last[i])
				{
					change_index = i;
					change_step = 0;
					change_num = str[i] - '0';
					str_last[i] = str[i];
					break;
				}
			}
		}
		lablel_printf(text1, "20%02u/%u/%u  %s", time.year, time.month, time.day, WEEKDAY_IN_STR[time.weekday - 1]);
		battery_life = iWatchGetBatteryLife();
		og_bmp_setBmp(bmp1, (t_psBMP)DrawBatteryIcon(battery_life));
	}
	if(pageExecuteRate(&Rate125Hz))
	{
		DisplayTimeInAnim();
	}
}
/**
  * @brief  页面事件
  * @param  btn:发出事件的按键
  * @param  event:事件编号
  * @retval 无
  */
static void Event(unsigned char event)
{
	if(event == KEY1_PRESSED)
		iWatchSleep();
	else if(event == KEY2_PRESSED || event == KEY3_PRESSED ||event == KEY4_PRESSED)
	{
		pageShift(page_menu, PAGE_ENTER);
	}
}
void pageRegister_page_watch(unsigned char pageID)
{
	pageRegister(pageID, NULL, NULL, Setup, Loop, Exit, Event);
}

unsigned char code WEEKDAY_IN_STR[7][6] = {
	"Mon. \0",
	"Tues.\0",
	"Wed. \0",
	"Thur.\0",
	"Fri. \0",
	"Sat. \0",
	"Sun. \0"
};
/****************************************16*48的点阵************************************/
/******************************************数字0~9**************************************/
unsigned char code DIGIT[10][96] = /* (16 X 48 , Tahoma, 加粗 )*/
{
	{
		0x00,0x00,0xE0,0xF8,0xFC,0xFE,0xFE,0xFE,0xFE,0xFE,0xFC,0xF8,0xE0,0x00,0x00,0x00,
		0xE0,0xFF,0xFF,0xFF,0xFF,0x1F,0x03,0x01,0x03,0x1F,0xFF,0xFF,0xFF,0xFF,0xE0,0x00,
		0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,
		0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,
		0x07,0xFF,0xFF,0xFF,0xFF,0xF8,0xC0,0x80,0xC0,0xF8,0xFF,0xFF,0xFF,0xFF,0x07,0x00,
		0x00,0x00,0x07,0x1F,0x3F,0x7F,0x7F,0x7F,0x7F,0x7F,0x3F,0x1F,0x07,0x00,0x00,0x00/*"0",0*/
	},
	{
		0x00,0x00,0x00,0x00,0x80,0xC0,0xFC,0xFC,0xFC,0xFC,0xFC,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x7F,0x7F,0x7F,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0xC0,0xC0,0xC0,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0xC0,0xC0,0xC0,0x00,
		0x00,0x00,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x00/*"1",1*/
	},
	{
		0x00,0xF8,0xF8,0xFC,0xFE,0xFE,0xFE,0xFE,0xFE,0xFC,0xFC,0xF8,0xE0,0x00,0x00,0x00,
		0x00,0x1F,0x0F,0x07,0x03,0x03,0x03,0x07,0x0F,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0xC0,0xF8,0xFE,0xFF,0xFF,0x7F,0x0F,0x01,0x00,0x00,0x00,
		0x00,0xC0,0xF0,0xFC,0xFF,0xFF,0xFF,0xDF,0xC7,0xC1,0xC0,0xC0,0xC0,0xC0,0xC0,0x00,
		0x00,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0x00/*"2",2*/
	},
	{
		0x00,0xF8,0xF8,0xFC,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0xFC,0xF8,0xF0,0x80,0x00,0x00,
		0x00,0x1F,0x0F,0x07,0x03,0x03,0x03,0x03,0x07,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
		0x00,0x00,0x00,0x00,0xF8,0xF8,0xF8,0xFC,0xFE,0xFF,0xFF,0xBF,0x0F,0x01,0x00,0x00,
		0x00,0x00,0x00,0x00,0x07,0x07,0x07,0x07,0x0F,0x1F,0xFF,0xFF,0xFF,0xFE,0xF0,0x00,
		0xF8,0xF0,0xE0,0xE0,0xC0,0xC0,0xC0,0xC0,0xE0,0xF0,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,
		0x1F,0x1F,0x3F,0x3F,0x7F,0x7F,0x7F,0x7F,0x7F,0x3F,0x3F,0x1F,0x0F,0x03,0x00,0x00/*"3",3*/
	},
	{
		0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xF8,0xFC,0xFC,0xFC,0xFC,0xFC,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0xE0,0xFC,0xFF,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,
		0x00,0x80,0xF0,0xFF,0xFF,0x3F,0x03,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,
		0xFC,0xFF,0xFF,0xFF,0xF1,0xF0,0xF0,0xF0,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,0xF0,0xF0,
		0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0xFF,0xFF,0xFF,0xFF,0xFF,0x0F,0x0F,0x0F,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0x3F,0x3F,0x3F,0x3F,0x00,0x00,0x00/*"4",4*/
	},
	{
		0x00,0x00,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0x00,0x00,
		0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x00,0x00,
		0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFC,0xFC,0xFC,0xFC,0xF8,0xF0,0xC0,0x00,0x00,
		0x00,0x00,0x07,0x07,0x03,0x03,0x03,0x03,0x07,0x0F,0xFF,0xFF,0xFF,0xFF,0xFE,0x00,
		0x00,0xF8,0xF0,0xE0,0xC0,0xC0,0xC0,0xC0,0xE0,0xF8,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,
		0x00,0x1F,0x3F,0x3F,0x7F,0x7F,0x7F,0x7F,0x7F,0x7F,0x3F,0x1F,0x0F,0x01,0x00,0x00/*"5",5*/
	},
	{
		0x00,0x00,0x80,0xE0,0xF0,0xF8,0xFC,0xFE,0xFE,0xFE,0xFE,0xFE,0xFC,0x00,0x00,0x00,
		0x00,0xF8,0xFF,0xFF,0xFF,0xFF,0x0F,0x03,0x01,0x01,0x01,0x01,0x03,0x00,0x00,0x00,
		0xFF,0xFF,0xFF,0xFF,0xFF,0xF8,0xFC,0xFE,0xFE,0xFE,0xFE,0xFC,0xF8,0xE0,0x00,0x00,
		0xFF,0xFF,0xFF,0xFF,0xFF,0x03,0x01,0x01,0x03,0x07,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,
		0x07,0xFF,0xFF,0xFF,0xFF,0xF8,0xC0,0x80,0x80,0xE0,0xFF,0xFF,0xFF,0xFF,0x3F,0x00,
		0x00,0x00,0x07,0x1F,0x3F,0x3F,0x7F,0x7F,0x7F,0x7F,0x3F,0x1F,0x0F,0x01,0x00,0x00/*"6",6*/
	},
	{
		0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0x00,
		0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0xC3,0xFF,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xFC,0xFF,0xFF,0xFF,0xFF,0x1F,0x01,0x00,0x00,
		0x00,0x00,0x00,0x00,0x80,0xF8,0xFF,0xFF,0xFF,0xFF,0x3F,0x03,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0xF8,0xFF,0xFF,0xFF,0xFF,0x7F,0x03,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x30,0x3F,0x3F,0x3F,0x3F,0x3F,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00/*"7",7*/
	},
	{
		0x00,0x00,0xE0,0xF8,0xFC,0xFC,0xFE,0xFE,0xFE,0xFE,0xFC,0xFC,0xF8,0xE0,0x80,0x00,
		0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x03,0x01,0x01,0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,
		0x00,0x07,0x3F,0xFF,0xFF,0xFF,0xFF,0xFC,0xF8,0xFC,0xFF,0xFF,0x1F,0x07,0x00,0x00,
		0xE0,0xFC,0xFE,0xFF,0xFF,0x0F,0x07,0x0F,0x1F,0x3F,0xFF,0xFF,0xFF,0xFE,0xF0,0x00,
		0x7F,0xFF,0xFF,0xFF,0xFF,0xE0,0xC0,0x80,0x80,0xE0,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,
		0x00,0x07,0x0F,0x1F,0x3F,0x7F,0x7F,0x7F,0x7F,0x7F,0x3F,0x1F,0x0F,0x03,0x00,0x00/*"8",8*/
	},
	{
		0x00,0x80,0xE0,0xF8,0xFC,0xFE,0xFE,0xFE,0xFE,0xFE,0xFC,0xF8,0xE0,0x80,0x00,0x00,
		0xF8,0xFF,0xFF,0xFF,0xFF,0x0F,0x01,0x01,0x03,0x0F,0xFF,0xFF,0xFF,0xFF,0xF0,0x00,
		0xFF,0xFF,0xFF,0xFF,0xFF,0xE0,0xC0,0x80,0x80,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,
		0x00,0x07,0x1F,0x3F,0x7F,0x7F,0x7F,0x7F,0x3F,0x1F,0xFF,0xFF,0xFF,0xFF,0x7F,0x00,
		0x00,0x00,0xC0,0x80,0x80,0x80,0x80,0xC0,0xF0,0xFF,0xFF,0xFF,0xFF,0x1F,0x00,0x00,
		0x00,0x00,0x7F,0x7F,0x7F,0x7F,0x7F,0x7F,0x3F,0x1F,0x0F,0x07,0x00,0x00,0x00,0x00/*"9",9*/
	}
};
unsigned char code COLON[98] = {	
	16, 48,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0xE0,0xE0,0xE0,0xE0,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00/*":"*/
};


void DisplayTimeInAnim(void)
{
	unsigned int k, num1, num2, temp;
	unsigned char j, num3;
	if(change_step < 24)
	{
		unsigned char *ptr = digit_temp[change_index] + 2;
		for(j = 0; j < 5; j ++)
		{
			num1 = j << 4;
			num2 = num1 + 16;
			for(k = num1; k < num2; k++)
			{
				temp = (ptr[k + 16] << 8) | ptr[k];
				ptr[k] = (temp >> 2);
			}
		}
		num1 = j << 4;
		num2 = (change_step / 4) << 4;
		num3 = 6 - ((change_step % 4) << 1);
		for(k = 0; k < 16; k++)	
		{
			ptr[num1 + k] = (ptr[num1 + k] >> 2) | ((DIGIT[change_num][num2 + k] << num3) & 0xC0);  
		}
		change_step++;
	}
}