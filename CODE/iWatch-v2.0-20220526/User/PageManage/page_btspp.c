#include "iWatch.h"
#include "Bluetooth.h"

static unsigned char CODE Icon[] = {
	48, 48,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0xF0,0xF8,0xF8,0xF0,0xE0,0xE0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0xC0,0xC0,0x80,0x00,
	0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x07,0x0F,0x1F,0x1F,0x3F,0xFE,0xFE,0xFC,0xF8,
	0xF0,0xE0,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x07,0x0F,0x0F,0x1F,0x3F,
	0x7F,0xFE,0xFC,0xFF,0xFF,0xFF,0xFF,0xF8,0xF8,0xFC,0x7E,0x7F,0x3F,0x1F,0x0F,0x07,
	0x07,0x03,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xE0,0xF0,0xF8,0xF8,0xFC,
	0x7E,0x7F,0x3F,0xFF,0xFF,0xFF,0xFF,0x0F,0x1F,0x3F,0x7F,0xFE,0xFC,0xF8,0xF0,0xE0,
	0xE0,0xC0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x03,0x03,0x01,0x00,
	0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xE0,0xF0,0xF8,0xF8,0xFC,0x7F,0x7F,0x3F,0x1F,
	0x0F,0x07,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x07,0x07,0x03,0x01,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
	/* (48 X 48 )*/
};

static t_psWidget lable1;

static unsigned char xdata is_bluetooth_connected = 0;
static unsigned char xdata rx_data[64];

void lableAppendTextWithRoll(char * text)
{
	int16_t temp;
	og_label_appendText(lable1, text);
	temp = lable1->y + lable1->h - 64;
	if(temp > 0)
		og_anim_create_offset(lable1, 0, -temp, ANIM_TIME_NORM, ANIM_NULL_CB);
	
}
void lableRollUp(void)
{
	if(lable1->y <= -32)
		og_anim_create_offset(lable1, 0, 32, ANIM_TIME_NORM, ANIM_NULL_CB);
	else
		og_anim_create_offset(lable1, 0, -lable1->y, ANIM_TIME_NORM, ANIM_NULL_CB);
}
void lableRollDown(void)
{
	if(lable1->y + lable1->h >= 96)
		og_anim_create_offset(lable1, 0, -32, ANIM_TIME_NORM, ANIM_NULL_CB);
	else
		og_anim_create_offset(lable1, 0, 64 - (lable1->y + lable1->h), ANIM_TIME_NORM, ANIM_NULL_CB);
}
/**
  * @brief  页面初始化事件
  * @param  无
  * @retval 无
  */
static void Setup(unsigned char condition)
{
	lable1 = og_label_create(FONT_ASCII_5X7, 0, 64);
	og_anim_create(lable1, 0, 0, ANIM_TIME_NORM, ANIM_NULL_CB);
	BtOn();
}
static void delet(void)
{
	og_widget_delet(lable1);
	pageSetStatus(page_bluetooth_serial, PAGE_IDLE);
}
/**
  * @brief  页面退出事件
  * @param  无
  * @retval 无
  */
static void Exit(unsigned char condition)
{
	BtOff();
	is_bluetooth_connected = 0;
	og_anim_create(lable1, 0, 64, ANIM_TIME_NORM, delet);
}
/**
  * @brief  页面循环执行的内容
  * @param  无
  * @retval 无
  */
static void Loop()
{
	if(pageExecuteRate(&Rate10Hz))
	{
		iWatchKeepActive();
		if(is_bluetooth_connected == 0)
		{
			if(BtCheckConnection())
			{
				is_bluetooth_connected = 1;
				lableAppendTextWithRoll("BT connected\n");
			}
		}
		else
		{
			if(BtCheckConnection() == 0)
			{
				is_bluetooth_connected = 0;
				lableAppendTextWithRoll("BT disconnected\n");
			}
		}
		if(BtReceiveString(rx_data))
		{
			lableAppendTextWithRoll(rx_data);
		}
	}
}
/**
  * @brief  页面事件
  * @param  btn:发出事件的按键
  * @param  event:事件编号
  * @retval 无
  */
static void Event(unsigned char event)
{
	if(event == KEY1_PRESSED)
		pageShift(page_menu, PAGE_RETURN);
	else if(event == KEY2_PRESSED)
	{
		lableRollUp();
	}
	else if(event == KEY3_PRESSED)
	{
		og_label_clear(lable1);
		og_widget_setPos(lable1, 0, 0);
	}
	else if(event == KEY4_PRESSED)
	{
		lableRollDown();
	}
	else if(event == AWT)
	{
		og_anim_create(lable1, 0, 64 - lable1->h, ANIM_TIME_NORM, ANIM_NULL_CB);
	}
}
void pageRegister_page_bluetooth_serial(unsigned char pageID)
{
	pageRegister(pageID, "Bluetooth SPP", Icon, Setup, Loop, Exit, Event);
}